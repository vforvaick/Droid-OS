#!/bin/bash
# Droid-OS Interactive Installer
# Sets up Droid-OS in your project with guided wizard

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DROID_OS_DIR="$(dirname "$SCRIPT_DIR")"
CURRENT_DIR="$(pwd)"

# Banner
echo ""
echo -e "${BLUE}${BOLD}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}${BOLD}â•‘     ðŸ¤– Droid-OS Interactive Setup Wizard     â•‘${NC}"
echo -e "${BLUE}${BOLD}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Detect project directory
echo -e "${BLUE}ðŸ“ Setup Location:${NC}"
echo -e "   Current directory: ${BOLD}$CURRENT_DIR${NC}"
echo -e "   Droid-OS location: ${BOLD}$DROID_OS_DIR${NC}"
echo ""

# Check if already initialized
if [[ -f "$CURRENT_DIR/.droidrc" ]]; then
    echo -e "${YELLOW}âš ï¸  This project is already initialized with Droid-OS${NC}"
    echo ""
    read -p "Reinitialize? This will overwrite existing config [y/N]: " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${BLUE}Setup cancelled.${NC}"
        exit 0
    fi
fi

echo -e "${GREEN}Let's get your project set up!${NC}"
echo ""

# ============================================
# QUESTION 1: Auto-detect Project Type
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}1ï¸âƒ£  Project Type Detection${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "We'll try to detect your project type automatically."
echo ""

# Auto-detect project type
PROJECT_TYPE="unknown"
DETECTED_FRAMEWORKS=""

if [[ -f "package.json" ]]; then
    if grep -q "next" package.json 2>/dev/null; then
        PROJECT_TYPE="nextjs"
        DETECTED_FRAMEWORKS="Next.js"
    elif grep -q "react" package.json 2>/dev/null; then
        PROJECT_TYPE="react"
        DETECTED_FRAMEWORKS="React"
    elif grep -q "vue" package.json 2>/dev/null; then
        PROJECT_TYPE="vue"
        DETECTED_FRAMEWORKS="Vue"
    else
        PROJECT_TYPE="nodejs"
        DETECTED_FRAMEWORKS="Node.js"
    fi
fi

if [[ -f "requirements.txt" ]] || [[ -f "setup.py" ]]; then
    if [[ -n "$DETECTED_FRAMEWORKS" ]]; then
        DETECTED_FRAMEWORKS="$DETECTED_FRAMEWORKS + Python"
    else
        PROJECT_TYPE="python"
        DETECTED_FRAMEWORKS="Python"
    fi
fi

if [[ -f "go.mod" ]]; then
    PROJECT_TYPE="go"
    DETECTED_FRAMEWORKS="Go"
fi

if [[ "$PROJECT_TYPE" != "unknown" ]]; then
    echo -e "${GREEN}âœ“ Detected:${NC} ${BOLD}$DETECTED_FRAMEWORKS${NC}"
else
    echo -e "${YELLOW}âš ï¸  Could not auto-detect project type${NC}"
    DETECTED_FRAMEWORKS="Generic"
fi

echo ""
read -p "Is this correct? [Y/n]: " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo ""
    echo "No problem! Please specify your project type:"
    echo "  1) Next.js"
    echo "  2) React"
    echo "  3) Vue"
    echo "  4) Node.js"
    echo "  5) Python (Django/Flask)"
    echo "  6) Go"
    echo "  7) Other/Generic"
    echo ""
    read -p "Choose [1-7]: " -n 1 -r MANUAL_CHOICE
    echo ""
    case $MANUAL_CHOICE in
        1) PROJECT_TYPE="nextjs"; DETECTED_FRAMEWORKS="Next.js" ;;
        2) PROJECT_TYPE="react"; DETECTED_FRAMEWORKS="React" ;;
        3) PROJECT_TYPE="vue"; DETECTED_FRAMEWORKS="Vue" ;;
        4) PROJECT_TYPE="nodejs"; DETECTED_FRAMEWORKS="Node.js" ;;
        5) PROJECT_TYPE="python"; DETECTED_FRAMEWORKS="Python" ;;
        6) PROJECT_TYPE="go"; DETECTED_FRAMEWORKS="Go" ;;
        7) PROJECT_TYPE="generic"; DETECTED_FRAMEWORKS="Generic" ;;
        *) PROJECT_TYPE="generic"; DETECTED_FRAMEWORKS="Generic" ;;
    esac
fi

echo ""
echo -e "${GREEN}âœ“ Project Type:${NC} ${BOLD}$DETECTED_FRAMEWORKS${NC}"
echo ""
sleep 1

# ============================================
# QUESTION 2: Setup Mode
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}2ï¸âƒ£  Installation Mode${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "How should we install Droid-OS files?"
echo ""
echo -e "${BOLD}[1] Symlink${NC} ${BLUE}(recommended for development)${NC}"
echo "    â†’ Files link to $DROID_OS_DIR"
echo -e "    ${GREEN}âœ“ Auto-updates when you pull latest Droid-OS changes${NC}"
echo -e "    ${YELLOW}âš ï¸  Changes in one project affect all projects${NC}"
echo ""
echo -e "${BOLD}[2] Copy${NC} ${BLUE}(recommended for production)${NC}"
echo "    â†’ Files are copied to your project"
echo -e "    ${GREEN}âœ“ Isolated - won't change unexpectedly${NC}"
echo -e "    ${YELLOW}âš ï¸  Need manual update when Droid-OS updates${NC}"
echo ""
echo -e "${BOLD}[3] Hybrid${NC} ${GREEN}(recommended - best of both worlds)${NC}"
echo "    â†’ Symlink droids/ (shared specialists)"
echo "    â†’ Copy commands/ and configs (project-specific)"
echo -e "    ${GREEN}âœ“ Get droid updates automatically${NC}"
echo -e "    ${GREEN}âœ“ Customize configs per project${NC}"
echo ""
read -p "Choose installation mode [1/2/3]: " -n 1 -r SETUP_MODE
echo ""
echo ""

case $SETUP_MODE in
    1) MODE_NAME="Symlink" ;;
    2) MODE_NAME="Copy" ;;
    3) MODE_NAME="Hybrid" ;;
    *)
        echo -e "${YELLOW}Invalid choice. Using Hybrid mode (recommended)${NC}"
        SETUP_MODE=3
        MODE_NAME="Hybrid"
        ;;
esac

echo -e "${GREEN}âœ“ Installation Mode:${NC} ${BOLD}$MODE_NAME${NC}"
echo ""
sleep 1

# ============================================
# QUESTION 3: Memory System
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}3ï¸âƒ£  Memory System${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "Enable orchestrator memory system?"
echo ""
echo "This creates: ${HOME}/.factory/orchestrator/memory/"
echo "  â€¢ success_patterns.json - Successful patterns from past projects"
echo "  â€¢ failure_patterns.json - Mistakes to avoid"
echo "  â€¢ project_templates.json - Reusable project templates"
echo "  â€¢ learning_metrics.json - Performance metrics"
echo ""
echo -e "${GREEN}Benefits:${NC}"
echo "  âœ“ Orchestrator learns from past projects"
echo "  âœ“ Applies successful patterns automatically"
echo "  âœ“ Avoids repeating past mistakes"
echo "  âœ“ Gets smarter over time"
echo ""
echo -e "${YELLOW}When to disable:${NC}"
echo "  â€¢ Privacy concerns (don't want to store project history)"
echo "  â€¢ Fresh start (no historical data yet)"
echo ""
read -p "Enable memory system? [Y/n]: " -n 1 -r ENABLE_MEMORY
echo ""
echo ""

if [[ $ENABLE_MEMORY =~ ^[Nn]$ ]]; then
    MEMORY_ENABLED="no"
    echo -e "${YELLOW}âŠ˜ Memory system disabled${NC}"
else
    MEMORY_ENABLED="yes"
    echo -e "${GREEN}âœ“ Memory system enabled${NC}"
fi
echo ""
sleep 1

# ============================================
# QUESTION 4: Command Shortcuts
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}4ï¸âƒ£  Command Shortcuts${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "Create command shortcuts in your project?"
echo ""
echo "This creates: commands/"
echo "  â€¢ orchestrator.md - Lightweight task-focused orchestrator"
echo "  â€¢ init-orchestrator.md - Comprehensive greenfield orchestrator"
echo ""
echo -e "${GREEN}Allows you to run:${NC}"
echo "  /orchestrator \"add feature X\""
echo "  /init-orchestrator \"build marketplace app\""
echo ""
read -p "Create command shortcuts? [Y/n]: " -n 1 -r CREATE_COMMANDS
echo ""
echo ""

if [[ $CREATE_COMMANDS =~ ^[Nn]$ ]]; then
    COMMANDS_ENABLED="no"
    echo -e "${YELLOW}âŠ˜ Command shortcuts disabled${NC}"
else
    COMMANDS_ENABLED="yes"
    echo -e "${GREEN}âœ“ Command shortcuts enabled${NC}"
fi
echo ""
sleep 1

# ============================================
# Summary & Confirmation
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸ“‹ Setup Summary${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "  Project Type:    ${BOLD}$DETECTED_FRAMEWORKS${NC}"
echo -e "  Install Mode:    ${BOLD}$MODE_NAME${NC}"
echo -e "  Memory System:   ${BOLD}$MEMORY_ENABLED${NC}"
echo -e "  Commands:        ${BOLD}$COMMANDS_ENABLED${NC}"
echo ""
read -p "Proceed with installation? [Y/n]: " -n 1 -r CONFIRM
echo ""
echo ""

if [[ $CONFIRM =~ ^[Nn]$ ]]; then
    echo -e "${BLUE}Setup cancelled.${NC}"
    exit 0
fi

# ============================================
# Installation Process
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸš€ Installing Droid-OS...${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Function to create symlink or copy
setup_directory() {
    local source=$1
    local target=$2
    local mode=$3
    local name=$4

    # Remove existing if present (with safety checks)
    if [[ -e "$target" ]] || [[ -L "$target" ]]; then
        # Safety validation before removal
        if [[ -z "$target" ]] || [[ "$target" == "/" ]] || [[ "$target" == "$HOME" ]] || [[ "$target" == "$HOME/" ]]; then
            echo -e "  ${RED}âœ—${NC} Unsafe removal path detected: $target"
            echo -e "  ${RED}Aborting for safety${NC}"
            exit 1
        fi

        # Ensure target is within current directory
        local target_abs=$(cd "$(dirname "$target")" 2>/dev/null && pwd)/$(basename "$target")
        local current_abs=$(pwd)
        if [[ "$target_abs" != "$current_abs"* ]]; then
            echo -e "  ${RED}âœ—${NC} Target path outside current directory: $target"
            echo -e "  ${RED}Aborting for safety${NC}"
            exit 1
        fi

        echo -e "  ${YELLOW}â†’${NC} Removing existing $name"
        rm -rf "$target"
    fi

    if [[ "$mode" == "symlink" ]]; then
        echo -e "  ${BLUE}â†’${NC} Linking $name"
        ln -s "$source" "$target"
        echo -e "  ${GREEN}âœ“${NC} Symlinked: $name -> $source"
    else
        echo -e "  ${BLUE}â†’${NC} Copying $name"
        cp -r "$source" "$target"
        local file_count=$(find "$target" -type f | wc -l | tr -d ' ')
        echo -e "  ${GREEN}âœ“${NC} Copied: $name ($file_count files)"
    fi
}

# Setup based on mode
case $SETUP_MODE in
    1) # Symlink mode
        setup_directory "$DROID_OS_DIR/droids" "$CURRENT_DIR/droids" "symlink" "droids/"
        setup_directory "$DROID_OS_DIR/orchestrator" "$CURRENT_DIR/orchestrator" "symlink" "orchestrator/"
        if [[ "$COMMANDS_ENABLED" == "yes" ]]; then
            setup_directory "$DROID_OS_DIR/commands" "$CURRENT_DIR/commands" "symlink" "commands/"
        fi
        ;;
    2) # Copy mode
        setup_directory "$DROID_OS_DIR/droids" "$CURRENT_DIR/droids" "copy" "droids/"
        setup_directory "$DROID_OS_DIR/orchestrator" "$CURRENT_DIR/orchestrator" "copy" "orchestrator/"
        if [[ "$COMMANDS_ENABLED" == "yes" ]]; then
            setup_directory "$DROID_OS_DIR/commands" "$CURRENT_DIR/commands" "copy" "commands/"
        fi
        ;;
    3) # Hybrid mode
        setup_directory "$DROID_OS_DIR/droids" "$CURRENT_DIR/droids" "symlink" "droids/"
        setup_directory "$DROID_OS_DIR/orchestrator" "$CURRENT_DIR/orchestrator" "symlink" "orchestrator/"
        if [[ "$COMMANDS_ENABLED" == "yes" ]]; then
            setup_directory "$DROID_OS_DIR/commands" "$CURRENT_DIR/commands" "copy" "commands/"
        fi
        ;;
esac

echo ""

# Initialize memory system
if [[ "$MEMORY_ENABLED" == "yes" ]]; then
    echo -e "${BLUE}â†’${NC} Initializing memory system"

    MEMORY_DIR="${HOME}/.factory/orchestrator/memory"
    mkdir -p "$MEMORY_DIR"

    # Create memory files if they don't exist
    # Use portable date format (works on both GNU and BSD/macOS)
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    if [[ ! -f "$MEMORY_DIR/success_patterns.json" ]]; then
        echo "{\"patterns\": [], \"last_updated\": \"$TIMESTAMP\"}" > "$MEMORY_DIR/success_patterns.json"
    fi

    if [[ ! -f "$MEMORY_DIR/failure_patterns.json" ]]; then
        echo "{\"patterns\": [], \"last_updated\": \"$TIMESTAMP\"}" > "$MEMORY_DIR/failure_patterns.json"
    fi

    if [[ ! -f "$MEMORY_DIR/project_templates.json" ]]; then
        echo "{\"templates\": [], \"last_updated\": \"$TIMESTAMP\"}" > "$MEMORY_DIR/project_templates.json"
    fi

    if [[ ! -f "$MEMORY_DIR/learning_metrics.json" ]]; then
        echo "{\"metrics\": {}, \"last_updated\": \"$TIMESTAMP\"}" > "$MEMORY_DIR/learning_metrics.json"
    fi

    echo -e "${GREEN}âœ“${NC} Memory system initialized at $MEMORY_DIR"
    echo ""
fi

# Create project config
echo -e "${BLUE}â†’${NC} Creating project configuration"
cat > "$CURRENT_DIR/.droidrc" << EOF
# Droid-OS Project Configuration
# Generated on $(date)

project_type=$PROJECT_TYPE
install_mode=$MODE_NAME
memory_enabled=$MEMORY_ENABLED
commands_enabled=$COMMANDS_ENABLED
droid_os_path=$DROID_OS_DIR
EOF

echo -e "${GREEN}âœ“${NC} Created .droidrc configuration"
echo ""

# ============================================
# Verification
# ============================================
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BOLD}ðŸ” Verifying Installation...${NC}"
echo -e "${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

ERRORS=0

# Check droids directory
if [[ -d "$CURRENT_DIR/droids" ]]; then
    DROID_COUNT=$(find "$CURRENT_DIR/droids" -name "*.md" -type f | wc -l | tr -d ' ')
    echo -e "${GREEN}âœ“${NC} droids/ directory exists ($DROID_COUNT specialists)"
else
    echo -e "${RED}âœ—${NC} droids/ directory missing"
    ((ERRORS++))
fi

# Check orchestrator directory
if [[ -d "$CURRENT_DIR/orchestrator" ]]; then
    echo -e "${GREEN}âœ“${NC} orchestrator/ directory exists"
else
    echo -e "${RED}âœ—${NC} orchestrator/ directory missing"
    ((ERRORS++))
fi

# Check key files
if [[ -f "$CURRENT_DIR/droids/orchestrator.md" ]]; then
    echo -e "${GREEN}âœ“${NC} droids/orchestrator.md exists"
else
    echo -e "${RED}âœ—${NC} droids/orchestrator.md missing"
    ((ERRORS++))
fi

if [[ "$COMMANDS_ENABLED" == "yes" ]]; then
    if [[ -f "$CURRENT_DIR/commands/orchestrator.md" ]]; then
        echo -e "${GREEN}âœ“${NC} commands/orchestrator.md exists"
    else
        echo -e "${RED}âœ—${NC} commands/orchestrator.md missing"
        ((ERRORS++))
    fi
fi

# Check config
if [[ -f "$CURRENT_DIR/.droidrc" ]]; then
    echo -e "${GREEN}âœ“${NC} .droidrc configuration created"
else
    echo -e "${RED}âœ—${NC} .droidrc configuration missing"
    ((ERRORS++))
fi

# Check memory (if enabled)
if [[ "$MEMORY_ENABLED" == "yes" ]]; then
    if [[ -d "${HOME}/.factory/orchestrator/memory" ]]; then
        echo -e "${GREEN}âœ“${NC} Memory system initialized"
    else
        echo -e "${YELLOW}âš ${NC} Memory system directory not found"
    fi
fi

echo ""

# ============================================
# Success Message
# ============================================
if [[ $ERRORS -eq 0 ]]; then
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}${BOLD}âœ“ Installation Complete!${NC}"
    echo -e "${GREEN}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${BOLD}ðŸš€ Next Steps:${NC}"
    echo ""

    if [[ "$COMMANDS_ENABLED" == "yes" ]]; then
        echo -e "  ${BOLD}For focused tasks:${NC}"
        echo -e "    /orchestrator \"add pagination to users table\""
        echo ""
        echo -e "  ${BOLD}For greenfield projects:${NC}"
        echo -e "    /init-orchestrator \"build a marketplace app\""
    else
        echo -e "  ${BOLD}Use orchestrator directly:${NC}"
        echo -e "    @orchestrator \"your task here\""
    fi

    echo ""
    echo -e "  ${BOLD}Check installation health:${NC}"
    echo -e "    droidos-doctor"
    echo ""
    echo -e "  ${BOLD}View configuration:${NC}"
    echo -e "    cat .droidrc"
    echo ""
else
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}${BOLD}âœ— Installation completed with errors${NC}"
    echo -e "${RED}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Please check the errors above and try again.${NC}"
    echo -e "${YELLOW}You can re-run this script to fix issues.${NC}"
    echo ""
    exit 1
fi
